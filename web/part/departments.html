<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="shortcut icon" type="image/x-icon" href="/image/favicon.ico"/>
    <link rel="stylesheet" href="../zui/zui.css">
    <script src="../javascript/jquery-2.0.3.min.js"></script>
    <script src="../javascript/jquery.cookie.js"></script>
    <script src="../zui/zui.js"></script>
    <script type="text/javascript">
        $(function () {
            // 手动初始化工具提示
            $('[data-toggle="tooltip"]').tooltip();
            //查询所有部类信息
            $("#submit3_1").click(function(){
                //查询所有部门信息
                findAllDeptInf();
            });
            function findAllDeptInf(){
                $.ajax({
                    type: "POST",
                    url: "ActionPart2_findAllDeptInf.action",
                    contentType: "application/x-www-form-urlencoded; charset=utf-8",
                    dataType: "json",
                    cache: false,
                    success: function (data) {
                        if (data.allJsonArray == "-1") {
                            new $.zui.Messager("Operation failed!", {
                                type: 'danger',
                                placement: 'top' // 定义显示位置
                            }).show();
                        }
                        if (data.allJsonArray.length == 0) {
                            $("#thead3_1").html('<tr><th>No date!</th></tr>');
                            $("#tbody3_1").html('');
                        } else if (data.allJsonArray.length != 0) {
                            //<th style="display: none">Id</th>
                            var head = '<tr><th>Id</th><th>Dept_No</th><th>PLU_No</th><th>Operation</th></tr>';
                            $("#thead3_1").html(head);
                            var html;
                            for (var i = 0; i < data.allJsonArray.length; i++) {

                                html += '<tr><td class="Id">' + data.allJsonArray[i].value1 + '</td>'
                                    + '<td class="Dept_No">' + data.allJsonArray[i].value2 + '</td>'
                                    + '<td class="PLU_No">' + data.allJsonArray[i].value3 + '</td>'
                                    + '<td><a name="deptInfModify" href="#" data-toggle="tooltip" data-tip-class="tooltip-primary" title="modify"><i class="icon icon-edit"></i></a> </td></tr>';
                            }
                            $("#tbody3_1").html(html);
                            // 手动初始化工具提示
                            $('[data-toggle="tooltip"]').tooltip();
                        }
                    },
                    error: function (jqXHR) {
                        new $.zui.Messager("Operation failed, possible causes：" + jqXHR.status, {
                            type: 'danger',
                            placement: 'top' // 定义显示位置
                        }).show();
                    }
                });
            }
            //因为表格是自动生成的，所以只能用on函数，click事件无效
            $("#tbody3_1").on("click", "a[name='deptInfModify']", function () {
                $("#updateId").val($(this).parents("tr").find(".Id").text());
                $("#value3_1").text($(this).parents("tr").find(".Id").text());
                $("#value3_2").val($(this).parents("tr").find(".Dept_No").text());
                $("#value3_3").val($(this).parents("tr").find(".PLU_No").text());
                $("#myModal_modifyDetpInf").modal();
            });

            //查询所有商品的信息，并显示
            function findAllGoodsInf() {
                var html = '<div style="height: 350px;" class="table-responsive"><table id="table1" class="table table-striped table-hover table-bordered">' +
                    '<thead><tr><th>Number</th><th>Name</th><th>Barcode</th><th>Price</th><th>Choose</th></tr></thead>' +
                    '<tbody id="tbody1">';
                //查询所有商品信息
                $.ajax({
                    type: "POST",
                    url: "ActionPart2_findAllGoodsInf.action",
                    contentType: "application/x-www-form-urlencoded; charset=utf-8",
                    dataType: "json",
                    async: false,//ajax 默认是 异步请求，为了获得校验结果，需设置成async: false,同步方式
                    cache: false,
                    success: function (data) {
                        if (data.allJsonArray == "-1") {
                            //操作失败
                            new $.zui.Messager("operation failed!", {
                                type: 'danger',
                                placement: 'top' // 定义显示位置
                            }).show();
                        }
                        if (data.allJsonArray.length == 0) {
//                            $("#thead1").html('<tr><th>No date!</th></tr>');
//                            $("#tbody1").html('');
                        } else if (data.allJsonArray.length != 0) {
                            for (var i = 0; i < data.allJsonArray.length; i++) {
                                html += '<tr><td class="Number">' + data.allJsonArray[i].value1 + '</td>'
                                    + '<td class="Name">' + data.allJsonArray[i].value2 + '</td>'
                                    + '<td class="Barcode">' + data.allJsonArray[i].value3 + '</td>'
                                    + '<td class="Price">' + (parseFloat(data.allJsonArray[i].value4) / 100).toFixed(2) + '</td>'
                                    + '<td><a name="choosePLU_No" href="#" data-toggle="tooltip" data-tip-class="tooltip-primary" title="Choose"><i class="icon icon-pencil"></i></a></td></tr>';
                            }
                            html += '</tbody></table></div>';
                            //手动初始化工具提示
                            $('[data-toggle="tooltip"]').tooltip();
                            return html;
                        }
                    },
                    error: function (jqXHR) {
                        new $.zui.Messager("Operation failed, possible causes：" + jqXHR.status, {
                            type: 'danger',
                            placement: 'top' // 定义显示位置
                        }).show();
                    }
                });
                return html;
            }
            //修改商品，选择Tax Index
            $("#button_ChoosePLUNo").popover({
                html: true,
                title: "Choose PLU_No",
                placement: 'left',
                content: findAllGoodsInf()
            });

            //因为表格是自动生成的，所以只能用on函数，click事件无效
            $("body").on("click", "a[name='choosePLU_No']", function () {
                $("#value3_3").val($(this).parents("tr").find(".Number").text());
                $("#button_ChoosePLUNo").popover('hide');//关闭对话框
            });

            //修改部门关联信息 对话框 点击事件
            $("#submit3_2").click(function(){
                $.ajax({
                    type: "POST",
                    url: "ActionPart2_updateOneDeptInf.action",
                    contentType: "application/x-www-form-urlencoded; charset=utf-8",
                    data: {
                        "Id": $("#updateId").val(),
                        "Dept_No":$("#value3_2").val(),
                        "PLU_No":$("#value3_3").val()
                    },
                    dataType: "json",
                    cache: false,
                    success: function (data) {
                        if (data.jsonObject == "-3") {
                            new $.zui.Messager("Login timeout, please login again!", {
                                type: 'danger',
                                placement: 'top' // 定义显示位置
                            }).show();
                            setTimeout(function () {
                                location.href = "login.html";//重定向
                            }, 2000);
                        } else if (data.jsonObject == "1") {
                            new $.zui.Messager("修改成功!", {
                                type: 'success',
                                placement: 'top' // 定义显示位置
                            }).show();
                            findAllDeptInf();//刷新表格
                            $("#updateId").val("");
                            $("#myModal_modifyDetpInf").modal('hide');//关闭对话框
                        } else if (data.jsonObject == "-1") {
                            new $.zui.Messager("修改失败，可能原因：服务器出错!", {
                                type: 'danger',
                                placement: 'top' // 定义显示位置
                            }).show();
                        } else if (data.jsonObject == "0") {
                            new $.zui.Messager("修改失败，可能原因：数据库出错!", {
                                type: 'danger',
                                placement: 'top' // 定义显示位置
                            }).show();
                        }
                    },
                    error: function (jqXHR) {
                        new $.zui.Messager("Operation failed, possible causes：" + jqXHR.status, {
                            type: 'danger',
                            placement: 'top' // 定义显示位置
                        }).show();
                    }
                });
            });
        });
    </script>
    <style>
        html,body {
            padding: 0;
            margin: 0;
            font-family: Arial;
            font-size: 14px;
            width: 100%;
            height:100%;
            overflow: auto;
            overflow-x: auto;
        }
        .popover {
            width: auto;
            max-width: 800px;
            height: auto;
            max-height: 600px;
        }
    </style>
</head>
<body>
<!--部类-->
<div>
    <span class="label label-badge label-primary label-define"
          style="float: left; margin-left: 20px;margin-top: 10px">Departments Management</span>
    <button id="submit3_1" class="btn btn-primary" type="button"
            style="float: right; margin-right: 20px"><i class="icon icon-refresh"></i> Refresh
    </button>

</div>
<div style="background-color: white ;margin-top: 40px; " class="table-responsive">
    <!--   table-striped table-hover table-bordered-->
    <table id="table3_1" class="table table-striped table-fixed table-hover" >
        <thead id="thead3_1">
        </thead>
        <tbody id="tbody3_1">
        </tbody>
    </table>
</div>

<!--对话框 修改部门关联信息-->
<div class="modal fade" id="myModal_modifyDetpInf">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span
                        class="sr-only">Close</span></button>
                <h4 class="modal-title">Modify Department Associate</h4>
            </div>
            <div class="modal-body">
                <div style="display: none">
                    <input id="updateId">
                </div>
                <form class="form-horizontal">
                    <div class="form-group">
                        <label class="col-sm-3">Id</label>
                        <label id="value3_1" class="col-sm-3" style="font-size: 16px"></label>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-3">Dept_No</label>
                        <div class="col-sm-6">
                            <select id="value3_2" class="form-control">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-3">PLU_No</label>
                        <div class="col-sm-6">
                            <input id="value3_3" type="number" class="form-control" placeholder="Please input the PLU_No">
                        </div>
                        <button id="button_ChoosePLUNo" type="button" class="btn btn-default" >...</button>
                    </div>
                    <div class="modal-footer">

                        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel
                        </button>
                        <button id="submit3_2" class="btn btn-primary" type="button">
                            Submit
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
</body>
</html>