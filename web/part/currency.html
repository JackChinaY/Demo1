<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="shortcut icon" type="image/x-icon" href="/image/favicon.ico"/>
    <link rel="stylesheet" href="../zui/zui.css">
    <script src="../javascript/jquery-2.0.3.min.js"></script>
    <script src="../javascript/jquery.cookie.js"></script>
    <script src="../zui/zui.js"></script>
    <script type="text/javascript">
        $(function () {
            /**
             *在此统一定义一些常用字符串
             */
            var loginTimeout = "Login timeout, please login again !";
            var serverError = "possible reasons：server error !";
            /*******************************************************************************************/
            //查询所有外汇 点击事件
            $("#submit2").click(function () {
                findAllCurrency();
            });
            //自动加载数据
            findAllCurrency();

            //查询所有外汇 无参
            function findAllCurrency() {
                $.ajax({
                    type: "GET",
                    url: "ActionPart1_findAllCurrency.action",
                    contentType: "application/x-www-form-urlencoded; charset=utf-8",
                    dataType: "json",
                    cache: false,
                    success: function (data) {
                        //登录超时，请重新登录
                        if (data.jsonObject == "-3") {
                            new $.zui.Messager(loginTimeout, {
                                type: 'danger',
                                placement: 'top' // 定义显示位置
                            }).show();
                            setTimeout(function () {
                                location.href = "../login.html";//重定向
                            }, 2000);
                        }
                        //服务器出错
                        else if (data.jsonObject == "-1") {
                            new $.zui.Messager(serverError, {
                                type: 'danger',
                                placement: 'top' // 定义显示位置
                            }).show();
                        }
                        //正确传输过来数据
                        else {
                            //后台传过来的是json数组的字符串，需要先转成json数组对象
                            var jsonArray = $.parseJSON(data.jsonObject);
                            //当数组为[]空时
                            if (jsonArray.length == 0) {
                                $("#thead").html('<tr><th>No data！</th></tr>');
                                $("#tbody").html('');
                            }
                            //当数组为不为空时
                            else if (jsonArray.length != 0) {
                                var head = '<tr><th>Number</th><th>Abbreviation</th><th>Exchange_Rate</th><th>Operation</th></tr>';
                                $("#thead").html(head);
                                var html;
                                for (var i = 0; i < jsonArray.length; i++) {
                                    html += '<tr><td class="number">' + jsonArray[i].value1 + '</td>'
                                        + '<td class="abbreviation">' + jsonArray[i].value2 + '</td>'
                                        + '<td class="rate">' + (parseFloat(jsonArray[i].value3) / 10000).toFixed(4) + '</td>'
                                        + '<td>&nbsp;&nbsp;&nbsp;&nbsp;<a name="update" href="#" data-toggle="tooltip" data-tip-class="tooltip-primary" title="Modify"><i class="icon icon-edit"></i></a></tr>';
                                }
                                $("#tbody").html(html);
                                // 手动初始化工具提示
                                $('[data-toggle="tooltip"]').tooltip();
                            }
                        }
                    },
                    error: function (jqXHR) {
                        $("#modal-content").html("The operation failed, please try again. Possible causes:" + jqXHR.status + "！");
                        $("#myModal").modal();
                    }
                });
            }

            /*******************************************************************************************/
            //修改按钮，修改
            $("#tbody").on("click", "a[name='update']", function () {
                //数据初始化
                $("#number").html($(this).parents("tr").find(".number").text());
                $("#abbreviation").val($(this).parents("tr").find(".abbreviation").text());
                $("#rate").val($(this).parents("tr").find(".rate").text());
                $("#myModal1").modal({moveable: true});//显示对话框
            });
            //所有外币
            var abb = ["CNY", "USD", "GBP", "EUR", "JPY", "HKD", "DEM", "CHF", "FRF", "NLG", "ATS", "BEF", "ITL", "CAD", "AUD", "SEK", "DKK", "NOK", "FIM", "KRW", "THB", "PHP", "INR", "SUR", "BUK", "NZD", "SGD"];

            //组合成所有外币
            function findAllAbbreviation() {
                var html = '<div class="table-responsive" style="height: 360px;"><table class="table table-striped table-hover table-bordered" >' +
                    '<thead><tr><th>ID</th><th>Abbreviation</th><th>Selection</th></tr></thead><tbody>';
//                alert(abbreviationArray.length);
                for (var i = 0; i < abb.length; i++) {
                    html += '<tr><td>' + i + '</td>'
                        + '<td class="abbreviation">' + abb[i] + '</td>'
                        + '<td>&nbsp;&nbsp;<a name="abbreviation" href="#" title="select this one"><i class="icon icon-tag"></i></a></td></tr>';
                }
                html += '</tbody></table></div>';
                return html;
            }

            //弹出面板进行初始化，选择外币
            $("#Choose").popover({
                html: true,
                title: "Choose Abbreviation",
                placement: 'left',
                content: findAllAbbreviation()

            });
            //因为表格是自动生成的，所以只能用on函数，click事件无效
            $("body").on("click", "a[name='abbreviation']", function () {
                $("#abbreviation").val($(this).parents("tr").find(".abbreviation").text());
                $("#Choose").popover('hide');//关闭对话框
            });
            /*******************************************************************************************/
            //保存修改后的外汇
            $("#submit3").click(function () {
                if ($("#abbreviation").val() == "") {
                    new $.zui.Messager('The Abbreviation can not be empty!', {
                        type: 'danger',
                        placement: 'top'
                    }).show();
                } else if ($("#abbreviation").val().length != 3) {
                    new $.zui.Messager('The length of the Abbreviation must be 3 numbers!', {
                        type: 'danger',
                        placement: 'top'
                    }).show();
                } else if ($("#rate").val() == "") {
                    new $.zui.Messager('The Exchange Rate can not be empty!', {
                        type: 'danger',
                        placement: 'top'
                    }).show();
                } else {
                    $.ajax({
                        type: "POST",
                        url: "ActionPart1_modifyAbbreviation.action",
                        contentType: "application/x-www-form-urlencoded; charset=utf-8",
                        data: {
                            "value1": $("#number").text(),
                            "value2": $("#abbreviation").val(),
                            "value3": (parseFloat($("#rate").val()) * 10000)
                        },
                        dataType: "json",
                        cache: false,
                        success: function (data) {
                            //登录超时，请重新登录
                            if (data.jsonObject == "-3") {
                                new $.zui.Messager(loginTimeout, {
                                    type: 'danger',
                                    placement: 'top' // 定义显示位置
                                }).show();
                                setTimeout(function () {
                                    location.href = "../login.html";//重定向
                                }, 2000);
                            }
                            //服务器出错
                            else if (data.jsonObject == "-1") {
                                new $.zui.Messager(serverError, {
                                    type: 'danger',
                                    placement: 'top' // 定义显示位置
                                }).show();
                            }
                            //正确传输过来数据
                            else {
                                if (data.jsonObject == "0") {
                                    new $.zui.Messager('Submission failure. Please re-enter it !', {
                                        type: 'danger',
                                        placement: 'top'
                                    }).show();
                                } else if (data.jsonObject == "1") {
                                    new $.zui.Messager('Submit successfully !', {
                                        type: 'success',
                                        placement: 'top'
                                    }).show();
                                    $("#myModal1").modal('hide');
                                    findAllCurrency();
                                }
                            }
                        },
                        error: function (jqXHR) {
                            new $.zui.Messager("Operation failed, possible causes：" + jqXHR.status, {
                                type: 'danger',
                                placement: 'top' // 定义显示位置
                            }).show();
                        }
                    });
                }
            });
            /*******************************************************************************************/
        });
    </script>
    <style>
        html, body {
            padding: 0;
            margin: 0;
            font-family: Arial;
            font-size: 14px;
            /*min-height: 500px;*/
            /*min-width: 500px;*/
            width: 100%;
            height: 100%;
            overflow: auto;
            overflow-x: auto;
        }

        .popover {
            width: auto;
            max-width: 800px;
            height: auto;
            max-height: 600px;
        }
    </style>
</head>
<body>
<!--外币-->
<div>
    <div style="margin-top: 10px;width: 100%;height: 40px;">
        <span class="label label-badge label-primary label-define"
              style="float: left; margin-left: 20px;margin-top: 10px">Foreign Currency</span>
        <button id="submit2" class="btn btn-primary" type="button"
                style="float: right; margin-right: 20px"><i class="icon icon-refresh"></i> Refresh
        </button>
    </div>
    <div style="background-color: white;"
         class="table-responsive">
        <!--height: 400px;overflow: scroll; overflow-x: hidden-->
        <table id="table2_1" class="table table-striped table-hover table-bordered">
            <thead id="thead">
            </thead>
            <tbody id="tbody">
            </tbody>
        </table>
    </div>
</div>
<!--对话框-->
<div class="modal fade" id="myModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span
                        class="sr-only">Close</span></button>
                <h4 class="modal-title">Messages</h4>
            </div>
            <div class="modal-body">
                <p id="modal-content" style="font-weight: 800"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<!--对话框 修改-->
<div class="modal fade" id="myModal1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span
                        class="sr-only">Close</span></button>
                <h4 class="modal-title">Modify Foreign Currency</h4>
            </div>
            <div class="modal-body">
                <form class="form-horizontal">
                    <div class="form-group">
                        <label class="col-sm-3">Number</label>
                        <label id="number" class="col-sm-6" style="text-align: center"></label>
                    </div>

                    <div class="form-group">
                        <label class="col-sm-3">Abbreviation</label>
                        <div class="col-sm-6">
                            <input id="abbreviation" type="text" class="form-control" maxlength="3"
                                   style="text-transform: uppercase">
                        </div>
                        <strong>*</strong>
                        <button id="Choose" class="btn btn-default" type="button">
                            ...
                        </button>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-3">Exchange Rate</label>
                        <div class="col-sm-6">
                            <input id="rate" type="number" class="form-control" maxlength="6"
                                   placeholder="0.0001 - 99999.9999">
                        </div>
                        <strong>*</strong>
                    </div>

                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel
                </button>
                <button id="submit3" class="btn btn-primary" type="button">
                    Submit
                </button>
            </div>
        </div>
    </div>
</div>
</body>
</html>